---
comments: true
---

# æŸ¥è¯¢å¤„ç†

## Basic Steps in Query Processing

<div align="center">
    <img src="../../../image/i247.png" width="100%"></div>


æŸ¥è¯¢å¤„ç†çš„åŸºæœ¬æ­¥éª¤æ˜¯ï¼š

1. è§£æä¸è½¬æ¢ (Parsing and translation)

    - å°†æŸ¥è¯¢è½¬æ¢ä¸ºå…¶å†…éƒ¨å½¢å¼ï¼Œé€šå¸¸è½¬æ¢ä¸ºå…³ç³»ä»£æ•°å½¢å¼
    - è§£æå™¨æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š
        - æ£€æŸ¥æŸ¥è¯¢çš„è¯­æ³•æ˜¯å¦æ­£ç¡®
        - éªŒè¯æŸ¥è¯¢ä¸­å¼•ç”¨çš„å…³ç³»æ˜¯å¦å­˜åœ¨
        - æ£€æŸ¥å±æ€§åæ˜¯å¦æœ‰æ•ˆ

2. ä¼˜åŒ– (Optimization)

    - åœ¨æ‰€æœ‰ç­‰ä»·çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œé€‰æ‹©ä»£ä»·æœ€ä½çš„æ‰§è¡Œè®¡åˆ’
    - æŸ¥è¯¢ä¼˜åŒ–å™¨è´Ÿè´£ç”Ÿæˆæœ‰æ•ˆçš„æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’

3. æ‰§è¡Œ (Evaluation)

    - æŸ¥è¯¢æ‰§è¡Œå¼•æ“æ¥æ”¶æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
    - æŒ‰ç…§è®¡åˆ’æ‰§è¡Œå„ä¸ªæ“ä½œ
    - è¿”å›æŸ¥è¯¢ç»“æœç»™ç”¨æˆ·


!!! example "ğŸŒ°"
    å¯¹äºå¦‚ä¸‹çš„è¯­å¥:
    ```sql
    select name, title 
    from instructor natural join (teaches natural join course)
    where dept_name=â€˜Musicâ€™ and year = 2009; 
    ```

    ç”¨å…³ç³»ä»£æ•°æ¥è¡¨è¾¾å°±æ˜¯:
    $$
    \pi_{name,title}(\sigma_{dept\_name=â€˜Musicâ€™ \land year=2009}(instructor \bowtie (teaches \bowtie course)))
    $$

    ä¼˜åŒ–å‰ä¸ä¼˜åŒ–åçš„è¡¨è¾¾æ ‘ä¸º:

    <div align="center">
        <img src="../../../image/i248.png" width="100%"></div>

    ä»ä¸­å¯ä»¥çœ‹å‡ºå‡ ç‚¹é€»è¾‘:

    1. æŠŠé€‰æ‹©è¿ç®—å¾€å¶å­ä¸Šæ¨ï¼›å› ä¸ºå¶å­èŠ‚ç‚¹çš„è¡¨å°ï¼Œé€‰æ‹©è¿ç®—çš„ä»£ä»·å°ï¼Œå¹¶ä¸”è¿™æ ·ä¹Ÿèƒ½å‡å°‘ä¸­é—´ç»“æœé›†çš„å¤§å°ã€‚

    2. å°çš„è¡¨å…ˆè¿æ¥ï¼Œå‡å°‘ä¸­é—´ç»“æœé›†çš„å¤§å°ã€‚

    **An evaluation plan defines exactly what algorithm is used for each operation, and how the execution of the operations is coordinated.**

    å¦‚ä¸‹å›¾:
    <div align="center">
        <img src="../../../image/i249.png" width="100%"></div>

    å·¦è¾¹ä½¿ç”¨B+æ ‘æ‰«æï¼Œå³è¾¹ä½¿ç”¨çº¿æ€§æ‰«æï¼Œå¹¶ä¸”ä¸¤è¾¹æ˜¯å¯ä»¥Pipelineçš„ã€‚

    è¿˜æœ‰merge joinå’Œhash joinçš„åŒºåˆ«ã€‚

## Measurement of Query Cost
> Typically disk access is the predominant cost, and is also relatively easy to estimate. 
>
> ç¡¬ç›˜è®¿é—®çš„å¼€é”€æ€»æ˜¯æœ€å¤§çš„

æˆ‘ä»¬è€ƒè™‘å¦‚ä¸‹ä¸‰ä¸ªå› ç´ :

1. Number of seeks

2. Number of blocks read

3. Number of blocks written

é€šå¸¸å†™çš„ä»£ä»·æ¯”è¯»å¤§å¾ˆå¤šï¼Œå› ä¸ºä¸€èˆ¬å†™å®Œæˆ‘ä»¬è¿˜è¦è¯»ä¸€éæ¥æ£€éªŒã€‚

ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ä¸¤ä¸ªé‡æ¥è¯„ä¼°ä»£ä»·:

1. number of block transfers,ä¸ä¹‹ç›¸é…çš„æ˜¯$t_T$ â€“ time to transfer one block

2. number of seeks,ä¸ä¹‹ç›¸é…çš„æ˜¯$t_S$ â€“ time to perform one seek

3. å¯¹äºbæ¬¡å—ä¼ è¾“å’Œsæ¬¡å¯»é“ï¼Œä»£ä»·ä¸ºï¼š
    $$
    C = b \cdot t_T + s \cdot t_S$$

> We often use worst case estimates, assuming only the minimum amount of memory needed for the operation is available

## Selection Operation

### File scan

Algorithm **A1** (linear search).  Scan each file block and test all records to see whether they satisfy the selection condition.
> æˆ‘ä»¬å‡å®šå—æ˜¯è¿ç»­å­˜æ”¾çš„

- Worst Cost:$b_r \times t_T + t_S$
    - $b_r$æ˜¯å—æ•°ç›®

- Average Cost: $\frac{b_r}{2} \times t_T + t_S$
    - å¦‚æœæŸ¥æ‰¾çš„æ˜¯ä¸€ä¸ªä¸»é”®å€¼ï¼Œå¹¶ä¸”æˆ‘ä»¬æ‰¾åˆ°ç¬¦åˆçš„å°±åœæ­¢

### Index scan
> search algorithms that use an index
>
> 

#### A2 

A2 (primary B+-tree index / clustering B+-tree index, equality on key). 

- å³ä½¿ç”¨B+æ ‘ç´¢å¼•

- æ‰¾çš„æ˜¯ä¸»é”®å€¼

<div align="center">
    <img src="../../../image/i250.png" width="100%"></div>

Cost:

$$
C = (t_S + t_T) \cdot (h + 1)$$

- $h$æ˜¯æ ‘çš„é«˜åº¦

- B+æ ‘æ¯åˆ°æ–°çš„ä¸€å±‚,éƒ½è¦é‡æ–°å¯»é“ä¸€æ¬¡

- æœ€åè¦+1æ˜¯å› ä¸ºæˆ‘ä»¬è¦è¯»æ•°æ®å—

#### A3

A3 (primary B+-tree index/ clustering B+-tree index, equality on nonkey) 

- å³ä½¿ç”¨B+æ ‘ç´¢å¼•

- æ‰¾çš„æ˜¯éä¸»é”®å€¼

- æ‰€ä»¥å¯èƒ½æœ‰å¤šä¸ªç»“æœ

> Records will be on consecutive blocks, æ‰€ä»¥æœ€åæ‰¾æ•°æ®å—åªéœ€è¦å¯»é“ä¸€æ¬¡
>
> Let b = number of blocks containing matching records


<div align="center">
    <img src="../../../image/i251.png" width="100%"></div>

Cost:

$$
C = (t_S + t_T) \cdot h + t_S+ b \cdot t_T$$

#### A4

A4 (secondary B+-tree index , equality on key)

- å³ä½¿ç”¨B+æ ‘ç´¢å¼•

- æ‰¾çš„æ˜¯ä¸»é”®å€¼

- ä½†ä½¿ç”¨çš„æ˜¯éèšé›†ç´¢å¼•

<div align="center">
    <img src="../../../image/i252.png" width="100%"></div>

Costå’ŒA2ä¸€æ ·:

#### A4'

A4' (secondary B+-tree index , equality on nonkey)

- å³ä½¿ç”¨B+æ ‘ç´¢å¼•

- æ‰¾çš„æ˜¯éä¸»é”®å€¼

- ä½¿ç”¨çš„æ˜¯éèšé›†ç´¢å¼•

> m è¡¨ç¤ºæ”¾æŒ‡é’ˆçš„å—çš„æ•°é‡
>
> n è¡¨ç¤ºå¯¹åº”ç£ç›˜é‡Œçš„è®°å½•çš„æ•°é‡ã€‚

<div align="center">
    <img src="../../../image/i253.png" width="100%"></div>

$$
Cost = (t_S + t_T) \cdot (h + m + n)
$$

### Selections Involving Comparisons
> è¿›è¡ŒæŸ¥æ‰¾$\sigma_{A \leq B}(r)$æˆ–$\sigma_{A \geq B}(r)$ 

#### A5

A5 (primary B+-index / clustering B+-index index, comparison)

- ç´¢å¼•æ˜¯ä¸»é”®å€¼

- åŒ…å«æ¯”è¾ƒ

- å·²ç»æ’å¥½åº

1. å¯¹äº$\sigma_{A \geq B}(r)$
    
    - å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆçš„å€¼ï¼Œç„¶åé¡ºåºæ‰«æ

    - Costå’ŒA3ä¸€æ ·

2. å¯¹äº$\sigma_{A \leq B}(r)$

    - ä¸éœ€è¦ä½¿ç”¨ç´¢å¼•

    - ç›´æ¥ä»æ•°æ®å—é‡Œé¡ºåºæ‰«æï¼Œç›´åˆ°è¯»åˆ°ç¬¬ä¸€ä¸ªå…ƒç»„å¤§äºBä¸ºæ­¢

<div align="center">
    <img src="../../../image/i254.png" width="100%"></div>

#### A6

A6 (secondary B+-tree index, comparison)

1. å¯¹äº$\sigma_{A \geq B}(r)$
    - æ ¹æ®B+æ ‘ç´¢å¼•æ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆçš„å€¼ï¼Œç„¶åé¡ºåºæ‰«æ

2. å¯¹äº$\sigma_{A \leq B}(r)$
    - ç›´æ¥åœ¨å¶å­èŠ‚ç‚¹é€ä¸ªæ‰«æï¼Œç›´åˆ°è¯»åˆ°ç¬¬ä¸€ä¸ªå…ƒç»„å¤§äºBä¸ºæ­¢

    - ç„¶åå¯¹äºæ¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå»æ•°æ®å—é‡Œé¡ºåºè¯»

<div align="center">
    <img src="../../../image/i255.png" width="100%"></div>

### Implementation of Complex Selections
> å¯¹äºå¤šæ¡ä»¶çš„é€‰æ‹©:$\sigma_{\theta_1 \land \theta_2 \land ... \land \theta_n}(r)$

1. A7 (conjunctive selection using one index)
    - é€‰ä¸€ä¸ªæ¡ä»¶ï¼Œä»A1-A6ä¹‹é—´æ‰¾ä¸€ä¸ªæœ€ä¼˜çš„ç®—æ³•ï¼Œå¾—åˆ°ä¸€å †å…ƒç»„

    - åœ¨è¿™å †å…ƒç»„ä¸Šæµ‹è¯•å…¶ä»–æ¡ä»¶


2. A8 (conjunctive selection using composite index)
    - Use appropriate composite (multiple-key) index if available.

3. A9 (conjunctive selection by intersection of identifiers)
    - å¯¹äºæ¯ä¸€ä¸ªæ¡ä»¶ï¼Œä»A1-A6ä¸­é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„ç®—æ³•ï¼Œå¾—åˆ°ç»“æœé›†

    - æŠŠç»“æœé›†å–äº¤

### Algorithms for Complex Selections

1. å¯¹äºå¤šæ¡ä»¶çš„é€‰æ‹©:$\sigma_{\theta_1 \lor \theta_2 \lor ... \lor \theta_n}(r)$

    - Applicable if all conditions have available indices.

    - Otherwise use linear scan.

    - Use corresponding index for each condition, and take union of all the obtained sets of record pointers.

    - Then fetch records from file

2. å–åçš„é€‰æ‹©:$\sigma_{\neg \theta}(r)$

    - å…ˆç”¨çº¿æ€§æ‰«ææ‰¾å‡ºæ‰€æœ‰çš„å…ƒç»„ï¼Œç„¶ååœ¨å†…å­˜ä¸­è¿›è¡Œé€‰æ‹©

### Bitmap

æ²¡è®²

## Sorting
> å’ŒADSä¸­çš„[å¤–éƒ¨æ’åº](../ADS/exsort.md)å¾ˆåƒ,ä½†æ˜¯æˆ‘å½“æ—¶æ²¡å†™(æ‚²)

!!! definition "Runs ä¸ Pass"
    ä¸ºäº†é¿å…æ¨¡ç³Šï¼Œåœ¨è¿™é‡Œç›´æ¥æŠŠè¿™ä¸¤ä¸ªå…³é”®å®šä¹‰ç»™å‡º

    - **Run**:ä¸€ç»„å·²ç»æ’åºå¥½çš„æ•°æ®ï¼Œåˆå§‹çš„Runså¤§å°å’Œå†…å­˜å¤§å°ä¸€è‡´

    - **Pass**:ä¸€ä¸ªæŠŠNä¸ªRunså½’å¹¶æ’åºä¸º$\frac{N}{M}$ä¸ªRuns,å…¶ä¸­Mæ˜¯å†…å­˜ä¸­å¯ä»¥æ”¾çš„Blockæ•°é‡ã€‚

    <div align="center">
        <img src="../../../image/i256.png" width="80%"></div>

### æ’åºæ­¥éª¤

1. Create sorted runs(å½’å¹¶æ®µ )
    - Let i be 0 initially. 
    - Repeatedly do the following till the end of the relation:
        - Read M blocks of relation into memory
        
        - Sort the in-memory blocks  
        
        - Write sorted data to run $R_i$; increment 
        
        - Let the final value of i be N


2. Merge the runs (N-way merge)

    - $N \leq M$

        - é‚£ä¹ˆåªéœ€è¦ä¸€ä¸ªPass

        - ä¸ºæ¯ä¸€ä¸ªrunå‡†å¤‡ä¸€ä¸ªBlockä½œä¸ºç¼“å†²åŒºï¼Œå†æ¥ä¸€ä¸ªBlockä½œä¸ºè¾“å‡ºçš„ç¼“å†²åŒºï¼Œä»æ¯ä¸ªrunä¸­è¯»ä¸€ä¸ªBlockåˆ°ç¼“å†²åŒº

        - é‡å¤ä»¥ä¸‹è¿‡ç¨‹ç›´åˆ°ç»“æŸ:

            - å¯¹äºç¼“å†²åŒºé‡Œé¢æ‰€æœ‰Blockï¼Œå½’å¹¶å‡ºä¸€å—Blockåˆ°è¾“å‡ºç¼“å†²åŒºï¼Œç„¶åå†™åˆ°ç£ç›˜ä¸Š

            - å¦‚æœç¼“å†²åŒºé‡Œé¢çš„Blockéƒ½è¯»å®Œäº†ï¼Œé‚£ä¹ˆå°±ä»ç£ç›˜ä¸Šè¯»ä¸‹ä¸€ä¸ªBlockåˆ°ç¼“å†²åŒº

        <div align="center">
            <img src="../../../image/i258.png" width="60%"></div>

    
    - $N \geq m$
        - æ¯ä¸€æ¬¡ï¼ŒæŠŠNä¸ªRunså˜æˆ$\lceil \frac{N}{M-1} \rceil$ä¸ªRuns

        - å¦‚æœä»ç„¶æ•°é‡è¶…è¿‡ M, ç»§ç»­ pass.

        - E.g.  If M=11, and there are 90 runs, one pass reduces the number of runs to 9, each 10 times the size of the initial runs

### Cost analysis(Simple version)

ä»¤$b_r$ä¸ºéœ€è¦æ’åºçš„æ‰€æœ‰å—çš„æ•°ç›®

- Runsæ€»æ•°ç›®ä¸º$N = \lceil \frac{b_r}{M} \rceil$ï¼Œå› ä¸ºåˆå§‹æ—¶ä¸€ä¸ªRunsçš„å¤§å°å°±æ˜¯å†…å­˜çš„å¤§å°

- æ€»å…±éœ€è¦çš„Passæ•°ç›®ä¸º$P = \lceil \log_{M-1} N \rceil$

- å¯¹äºæ¯ä¸ªPasså’Œåˆå§‹çš„Runsçš„ç”Ÿæˆï¼ŒBlockçš„ä¼ è¾“æ¬¡æ•°éƒ½ä¸º$2b_r$ï¼Œå› ä¸ºæˆ‘ä»¬è¦è¯»å’Œå†™
    - éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯»ä¸€ä¸ªRunså’Œå†™ä¸€ä¸ªRunsçš„ä»£ä»·ä¸æ˜¯ä¸€ä¸ªBlockï¼Œè€Œæ˜¯Runsçš„å®é™…å¤§å°ã€‚æ¯è½®Passä¸­Runsçš„æ€»å¤§å°éƒ½æ˜¯$b_r$

    - æ¯æ¬¡éƒ½éœ€è¦è¯»å’Œå†™è¿™ä¹ˆå¤šBlockï¼Œæ‰€ä»¥ä»£ä»·æ˜¯$2b_r$

    - ç„¶è€Œï¼Œåœ¨æœ€åä¸€ä¸ªPassä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦è¯»ä¸€æ¬¡ï¼Œæ‰€ä»¥ä»£ä»·æ˜¯$b_r$ï¼Œå› ä¸ºå¯èƒ½ä¸ä¼šå†™å‘ç£ç›˜ï¼Œè€Œæ˜¯äº¤ç»™ä¸‹ä¸€æ­¥

- æ‰€ä»¥ï¼Œæ€»çš„Block Transfersä¸º:

    $$ 
    \begin{align}
    &2b_r( \lceil \log_{M-1} {b_r / M} \rceil-1) &\text{(ä¸­é—´ Pass çš„è¯»å†™)}\\ 
    &+ b_r &\text{(æœ€å Pass çš„è¯»å–)}\\ 
    &+ 2b_r &\text{(åˆå§‹ Runs ç”Ÿæˆçš„è¯»å†™)}
    \end{align}
    $$

    ä¹Ÿå³$C = 2b_r \lceil \log_{M-1} {b_r / M} \rceil + b_r$

- æ€»çš„Seekä¸º
    - åœ¨Runsçš„ç”Ÿæˆæ—¶ï¼Œéœ€è¦$2 \lceil \frac{b_r}{M} \rceil$æ¬¡å¯»é“

    - åœ¨æ¯ä¸ªPassä¸­ï¼Œéƒ½éœ€è¦$2 b_r$æ¬¡å¯»é“ï¼Œå› ä¸ºæ¯ä¸ªBlockéƒ½è¦è¢«åŠ è½½è¿›å†…å­˜ï¼Œå¹¶å†™å‡º

    - é™¤äº†æœ€åä¸€ä¸ªPass

    - æ‰€ä»¥æ€»çš„å¯»é“æ¬¡æ•°ä¸º:

        \begin{align}
        2 \lceil \frac{b_r}{M} \rceil + 2b_r \lceil \log_{M-1} {b_r / M} \rceil - b_r
        \end{align}

!!! example "ğŸŒ°"
    ![](../../image/i257.jpg)

### Cost analysis(Advance version)

æ¯æ¬¡åªè¯»ä¸€å—çš„Seekæ¬¡æ•°å¤ªå¤šäº†ï¼Œæˆ‘ä»¬æ”¹ä¸ºæ¯æ¬¡è¯»$b_b$å—

<div align="center">
    <img src="../../../image/i259.png" width="80%"></div>

è¿™æ ·ï¼Œä¸€æ¬¡å¯ä»¥æŠŠ$\lfloor \frac{M}{b_b} \rfloor -1$ä¸ªRunsåˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„Runs

- è¿™æ ·ï¼Œä¸€å…±éœ€è¦çš„Passæ•°ç›®ä¸º$P = \lceil \log_{\lfloor \frac{M}{b_b} \rfloor-1} (b_r /M) \rceil$

æ€»çš„Block Transfersä¸º:

$$
C = 2b_r \lceil \log_{\lfloor \frac{M}{b_b} \rfloor-1} {b_r / M} \rceil + b_r
$$

- æ€»çš„Seekä¸º:
    - åœ¨ç”ŸæˆRunsæ—¶ï¼Œä¹ŸåŒæ ·æ˜¯Runsä¸ªæ•°çš„ä¸¤å€:$2 \lceil \frac{b_r}{M} \rceil$

    - ä¸åŒçš„æ˜¯ï¼Œç°åœ¨æ¯ä¸ªPassä¸­è¯»å’Œå†™çš„å¯»é“ä¸ªæ•°éƒ½æ˜¯$\lceil \frac{b_r}{b_b} \rceil$

    - æ‰€ä»¥æ€»çš„å¯»é“æ¬¡æ•°ä¸º:

        \begin{align}
        2 \lceil \frac{b_r}{M} \rceil + 2\lceil \frac{b_r}{b_b} \rceil \lceil \log_{\lfloor \frac{M}{b_b} \rfloor-1} {b_r / M} \rceil - b_r
        \end{align}

## Join Operation
> æˆ‘ä»¬ä½¿ç”¨çš„ä¾‹å­æ•°æ®æ˜¯:
>
> Number of records of student:5,000,takes:10,000
>
> Number of blocks of student:100,takes:400


æˆ‘ä»¬å¸Œæœ›å®Œæˆ$ r \bowtie_\theta s$

### Nested-Loop Join

```plaintext
for each tuple tr in r do begin
    for each tuple ts in s do begin
        test pair (tr,ts) to see if they satisfy the join condition theta

        if they do, add tr â€¢ ts to the result.
    end
end
```

- è¿™æ˜¯æœ€æœ´ç´ çš„åšæ³•

- r è¢«ç§°ä¸ºouter relationï¼Œs è¢«ç§°ä¸ºinner relation.

- åœ¨æœ€åçš„æƒ…å†µï¼Œå¦‚æœå†…å­˜æ¯æ¬¡åªèƒ½å®¹çº³ä¸¤ä¸ªå…³ç³»å„ä¸€ä¸ªBlock
    - $n_r * b_s + b_r$æ¬¡å—ä¼ è¾“
        - å› ä¸ºrçš„æ¯ä¸ªå…ƒç»„éƒ½è¦å’Œsçš„æ¯ä¸ªå…ƒç»„è¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥rçš„ä¸€ä¸ªå…ƒç»„è¦éå†sçš„æ‰€æœ‰å—

    - $n_r + b_r$æ¬¡å¯»é“(å‡è®¾ä¸€ä¸ªå…³ç³»çš„å—æ˜¯è¿ç»­å­˜æ”¾çš„ï¼Œæ¯ä¸€ä¸ªrçš„å…ƒç»„è¦Seekä¸€æ¬¡æ¥æ‰¾åˆ°sçš„å—)

    - $n_s$æ˜¯å…³ç³»sçš„å…ƒç»„æ•°ç›®

    - $b_s$æ˜¯å…³ç³»sçš„å—æ•°ç›®

    - $b_r$æ˜¯å…³ç³»rçš„å—æ•°ç›®

- ä½†æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå…³ç³»çš„å…ƒç»„è¶³å¤Ÿå°‘ï¼Œå°‘åˆ°èƒ½æ•´ä¸ªæ”¾è¿›å†…å­˜ä¸­
    - æˆ‘ä»¬æŠŠè¿™ä¸ªå…³ç³»å½“ä½œå†…å…³ç³»,å§‹ç»ˆæ”¾åœ¨å†…å­˜ä¸­

    - $b_r +b_s$æ¬¡å—ä¼ è¾“
        - å› ä¸ºæˆ‘ä»¬åªéœ€è¦è¯»ä¸€æ¬¡å†…å…³ç³»çš„æ‰€æœ‰å—
    
    - ä¸¤æ¬¡å¯»é“
        - ä¸€æ¬¡æ˜¯è¯»å†…å…³ç³»çš„å—ï¼Œä¸€æ¬¡æ˜¯è¯»å¤–å…³ç³»çš„å—

<div align="center">
    <img src="../../../image/i260.png" width="80%"></div>

### Block Nested-Loop Join

ä¸Šä¸€ä¸ªç®—æ³•çš„é—®é¢˜å°±åœ¨äºï¼Œå…³ç³»è¡¨ä¸­è¿ç»­å­˜æ”¾çš„å…ƒç»„åœ¨å—ä¸­ä¸ä¸€å®šæ˜¯è¿ç»­å­˜æ”¾çš„ï¼Œå› æ­¤æˆ‘ä»¬å¦‚æœä»¥å—ä¸ºå•ä½è¯»å–ï¼Œå…ˆè¯»å–å—ï¼Œå†è¯»è¿™ä¸ªå—é‡Œé¢çš„å…ƒç»„ï¼Œé‚£å°±å¯ä»¥å‡å°‘å¯»é“æ¬¡æ•°ä¸å—ä¼ è¾“æ¬¡æ•°ã€‚

ç›¸å½“äºï¼Œæˆ‘ä»¬å…ˆå„è¯»ä¸€ä¸ªå—ï¼Œç„¶ååœ¨å†…å­˜ä¸­æ¯”è¾ƒï¼Œç›¸å½“äºæŒ‰å—çš„é¡ºåºæ¥æ¯”è¾ƒ

<div align="center">
    <img src="../../../image/i261.png" width="80%"></div>

åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæœ€å:

- $b_r * b_s + b_r$æ¬¡å—ä¼ è¾“

    - Each block in the inner relation s is read once for each block in the outer relation

- $b_r + b_r$æ¬¡å¯»é“

æœ€å¥½çš„æƒ…å†µæ˜¯ä¸€æ ·çš„

--- 

Improvements to block nested loop algorithms:

å‡è®¾å†…å­˜æœ‰ M å—ï¼Œæœ‰ä¸€å—ä½œä¸º output çš„ç¼“å†²ï¼Œå‰©ä¸‹ M-1 å—ä¸­ M-2 å—å‡ç»™å¤–å…³ç³»ï¼Œå†…å…³ç³»ç»™ä¸€å—ã€‚

<div align="center">
    <img src="../../../image/i262.png" width="80%"></div>

å½“ç„¶è¿˜æ˜¯æ²¿ç”¨å—åµŒå¥—å¾ªç¯çš„æ€æƒ³

- Block Transfers:$\lceil \frac{b_r}{M-2} \rceil * b_s + b_r$

- Seek: $2 \lceil \frac{b_r}{M-2} \rceil$
    - å‡è®¾å¯¹äºå¤–å…³ç³»ï¼Œä¸€æ¬¡è¯»å–è¿ç»­çš„M-2å—è¿›æ¥ï¼Œè¿™M-2å—åªéœ€è¦ä¸€æ¬¡å¯»é“ã€‚

- å¦‚æœè¿æ¥çš„å±æ€§æ˜¯ key, é‚£ä¹ˆå½“æˆ‘ä»¬åŒ¹é…ä¸Šä¹‹åå°±å¯ä»¥åœæ­¢å†…å¾ªç¯ã€‚

- åˆ©ç”¨ LRU ç­–ç•¥çš„ç‰¹ç‚¹ï¼Œinner æ­£å‘æ‰«æåå†åè¿‡æ¥ï¼Œè¿™æ ·æœ€è¿‘çš„å—å¾ˆå¯èƒ½è¿˜åœ¨å†…å­˜ä¸­ï¼Œæé«˜ç¼“å†²å‘½ä¸­ç‡ã€‚

### Indexed Nested-Loop Join

å¦‚æœå†…å¾ªç¯çš„å…³ç³»æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆå¯¹äºå¤–å¾ªç¯çš„æ¯ä¸€ä¸ªå…ƒç»„ï¼Œæˆ‘ä»¬æ ¹æ®ç‰¹å®šå±æ€§ä¸Šçš„å€¼åœ¨å†…å¾ªç¯çš„ç´¢å¼•é‡ŒæŸ¥æ‰¾ã€‚

Costï¼š$b_r (t_T + t_S) + n_r * c$

- cæŒ‡éå†ç´¢å¼•å¹¶æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å…ƒç»„çš„ä»£ä»·

!!! example "ğŸŒ°"
    ![](../../image/i263.png)


---

### Merge Join

<div align="center">
    <img src="../../../image/i264.png" width="80%"></div>

1. å¯¹äºæ¯ä¸€ä¸ªå…³ç³»ï¼Œå…ˆæŒ‰è¿æ¥å±æ€§æ’å¥½åº

2. Merge the sorted relations to join them
    - Join step is similar to the merge stage of the sort-merge algorithm.

    - Main difference is handling of duplicate values in join attribute â€” every pair with same value on join attribute must be matched

ç”±äºæ¯ä¸ªå—åªéœ€è¦ä¼ è¾“ä¸€æ¬¡ï¼Œæ‰€ä»¥:

- Block Transfers: $b_r + b_s$

- Seek: $ \lceil \frac{b_r}{b_b} \rceil + \lceil \frac{b_s}{b_b} \rceil$

ä¸€ä¸ªæ•°å­¦é—®é¢˜:å¦‚æœå†…å­˜æœ‰Må—ï¼Œå¦‚ä½•åˆ†é…ç»™ä¸¤ä¸ªå…³ç³»çš„å—ï¼Ÿ

ç­”æ¡ˆæ˜¯:
$$
x_r = \sqrt{b_r} \times \frac{M}{\sqrt{b_r} + \sqrt{b_s}}, \\
x_s = \sqrt{b_s} \times \frac{M}{\sqrt{b_r} + \sqrt{b_s}}
$$

### Hash-Join

æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼ŒæŠŠå…ƒç»„åˆ†å—ï¼Œè¿™æ ·ï¼Œç”±äºå“ˆå¸Œå‡½æ•°çš„ç‰¹ç‚¹ï¼Œèƒ½å¤Ÿè¿æ¥çš„å±æ€§çš„å€¼ä¸€å®šåœ¨åŒä¸€å—ä¸­ï¼Œåä¹‹ä¸ç„¶ã€‚

<div align="center">
    <img src="../../../image/i265.png" width="80%"></div>

å¹¶ä¸”ï¼Œåˆ†æˆçš„å—æ•°$n$ä¸å“ˆå¸Œå‡½æ•°è¦è®¾è®¡è¿‡ï¼Œä½¿å¾—å—çš„å¤§å°æ˜¯è¶³ä»¥æ”¾è¿›å†…å­˜çš„ã€‚

$n \geq \lceil \frac{b_s}{M} \rceil$

#### Hash-Join Algorithm

1. å¯¹å…³ç³»sç”¨å“ˆå¸Œå‡½æ•°Hï¼Œå†…å­˜åŒæ ·ä¿ç•™input bufferå’Œoutput bufferï¼Œåˆ†ç‰‡ä¹‹åå†å†™å‡ºå»

2. å…³ç³»rä¹Ÿç”¨å“ˆå¸Œå‡½æ•°Hï¼Œåˆ†ç‰‡ä¹‹åå†å†™å‡ºå»

3. æŠŠsçš„ç¬¬iä¸ªåˆ†å—åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶åœ¨è¿æ¥å±æ€§ä¸Šå†ç”¨ä¸€ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°å»ºç«‹å“ˆå¸Œç´¢å¼•

4. æŠŠrçš„ç¬¬iä¸ªåˆ†å—åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ¯ä¸ªå…ƒç»„åœ¨è¿æ¥å±æ€§ä¸Šä½œå“ˆå¸Œï¼Œå°±èƒ½å¾ˆå¿«æ‰¾åˆ°sä¸­åŒ¹é…çš„å…ƒç»„

5. æŠŠè¿æ¥ç»“æœè¾“å‡º

å› æ­¤ï¼Œsè¢«å«åšbuild inputï¼Œrè¢«å«åšprobe input

!!! definition "ä¿®æ­£å› å­"
    é€šå¸¸nä¼šè¢«é€‰ä¸º$\lceil \frac{b_s}{M} \rceil *f$

    å…¶ä¸­fæ˜¯ä¿®æ­£å› å­ï¼Œé€šå¸¸å–1.2

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ†å—çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ±‚å¯¹äºæ¯ä¸ªå—éƒ½è¦æœ‰ä¸€ä¸ªè¾“å‡ºç¼“å†²å—ï¼Œæ¯”å¦‚å“ˆå¸Œå‡½æ•°æ˜ å°„çš„å€¼èŒƒå›´æ˜¯0åˆ°n-1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æœ‰nä¸ªè¾“å‡ºç¼“å†²å—,æ ¹æ®å“ˆå¸Œå‡½æ•°çš„å€¼æ¥å†³å®šè¾“å‡ºç¼“å†²å—çš„ç¼–å·ã€‚

ç”±æ­¤å°±å¼•å‘äº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¿™æ ·çš„ç®—æ³•è¦æ±‚æ¯æ¬¡åˆ†å—çš„ä¸ªæ•°å¿…ç„¶ä¸èƒ½å¤§äºå†…å­˜çš„å—æ•°ï¼Œå¦‚æœåŸæ¥å…³ç³»å¾ˆå¤§ï¼Œå¤§åˆ°å³ä½¿åˆ†æˆè¿™ä¹ˆå¤šå—ï¼Œå¤§å°è¿˜æ˜¯å¤ªå¤§äº†æ€ä¹ˆåŠ?

æ‰€ä»¥è¦ç”¨Recursive partitioning

#### Recursive partitioning

- Instead of partitioning n ways, use  M â€“ 1 partitions for s

- Further partition the M â€“ 1 partitions using a different hash function

- For example, consider a memory size of 12M bytes, divided into 4K bytes blocks; it would contain a total of 3K (3072) blocks. We can use a memory of this size to partition relations of size up to 3K âˆ— 3K blocks, which is 36G (3K âˆ— 3K âˆ— 4K ) bytes. 

#### Cost of Hash Join

<div align="center">
    <img src="../../../image/i266.png" width="80%"></div>

<div align="center">
    <img src="../../../image/i267.png" width="80%"></div>

!!! example "ğŸŒ°"
    ![](../../image/i268.png)

## Other Operations

- Duplicate elimination can be implemented via hashing or sorting.

    - On sorting duplicates will come adjacent to each other, and all but one set of duplicates can be deleted.  

    - Optimization: duplicates can be deleted during **run generation** as well as at intermediate merge steps in external sort-merge.

    - Hashing is similar â€“ duplicates will come into the same bucket.

- Aggregation can be implemented in a manner similar to duplicate elimination.
    
    - Sorting or hashing can be used to bring tuples in the same group together, and then the aggregate functions can be applied on each group. 

    - Optimization: combine tuples in the same group during run generation and intermediate merges, by computing partial aggregate values
        
        - For count, min, max, sum: keep aggregate values on tuples found so far in the group.  
        
            - When combining partial aggregate for count, add up the aggregates

        - For avg, keep sum and count, and divide sum by count at the end

- é›†åˆæ“ä½œ

    1. å¯¹æ¯ä¸ªå…³ç³»åˆ†å—

    2. å¯¹äºæ¯ä¸ªiï¼Œ$r_i$å»ºç«‹å“ˆå¸Œç´¢å¼•

        - å¦‚æœæ˜¯å–å¹¶é›†:
            
            - å¦‚æœ$s_i$ä¸­çš„å…ƒç»„ç»è¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åï¼Œå€¼ä¸å­˜åœ¨ï¼Œåˆ™åŠ å…¥å“ˆå¸Œç´¢å¼•ä¸­

            - è¾“å‡ºå“ˆå¸Œç´¢å¼•

        - å¦‚æœæ˜¯å–äº¤é›†:
            
            - å¦‚æœ$s_i$ä¸­çš„å…ƒç»„ç»è¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åï¼Œå€¼å­˜åœ¨ï¼Œå°±è¾“å‡º

        - å¦‚æœæ˜¯å–å·®é›†:
            
            - å¦‚æœ$s_i$ä¸­çš„å…ƒç»„ç»è¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åï¼Œå€¼å¦‚æœå­˜åœ¨ï¼Œå°±ä»å“ˆå¸Œç´¢å¼•ä¸­åˆ é™¤

            - è¾“å‡ºå“ˆå¸Œç´¢å¼•ä¸­çš„æ‰€æœ‰å…ƒç»„

- Outer Join
    <div align="center">
        <img src="../../../image/i269.png" width="80%"></div>