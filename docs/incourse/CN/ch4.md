---
comments : true
---

# 网络层
> 网络层的主要任务是将Packet从源地址经过多个网络传输到目的地址.该任务可以拆分为分组转发和路由选择两个子任务.
> 
> 路由表存储了目的ip地址与子网掩码,下一跳路由器地址,出接口等信息,路由选择算法根据路由表选择最佳路径将数据包发送到目的地址.

OSI模型主张在网络层建立面向连接的虚电路,依靠网络来确保可靠传输.而TCP/IP模型则主张在网络层建立无连接的分组交换网络,由用户主机来保证通信的可靠.

## 异构网络互联

网际协议(Internet Protocol,IP)是实现异构网络互联的基础协议.它定义了IP地址的格式,数据报的格式,以及路由选择等内容.IP协议是无连接的,每个数据报独立传输,不保证可靠性

异构网络互联的基本思想是将不同类型的网络通过路由器连接起来,形成一个统一的网络体系结构.路由器负责在不同网络之间转发数据报,并根据路由选择算法选择最佳路径.当IP网上的主机通信时,它们会感觉自己直接连接在一起,而不需要关心底层网络的差异.

## IPV4地址
> IPV4地址是每一个联网设备的唯一标识,由32位二进制数组成,通常表示为四个十进制数(0-255)用点分隔开.

IPV4地址分为网络地址和主机地址两部分,网络地址用于标识一个网络,主机地址用于标识网络中的一台主机.子网掩码用于区分网络地址和主机地址,通过与运算可以得到网络地址.

### 分类编址方法

IPV4地址根据网络规模分为A,B,C,D,E五类:

- A类地址: 网络号占8位,主机号占24位,适用于大型网络.范围: 1.0.0.0 - 126.255.255.254

- B类地址: 网络号占16位,主机号占16位,适用于中型网络.范围: 128.0.0.0 - 191.255.255.254

- C类地址: 网络号占24位,主机号占8位,适用于小型网络.范围: 192.0.0.0 - 223.255.255.254

- D类地址: 用于多播通信.范围: 224.0.0.0 - 239.255.255.255

- E类地址: 保留地址,用于实验和研究.范围: 240.0.0.0 - 255.255.255.255

注意:

- 主机号全0表示网络地址,主机号全1表示广播地址,不能分配给主机使用.

<div style="text-align: center;">
    <img src="../../../image/mac191.png" width="80%">
    <br>
    <caption>特殊的IPV4地址</caption>
</div>

---

### 划分子网编址


分类编址的IPV4地址容易造成浪费,例如,一个子网中有100000台设备,此时采用A类地址,还剩下许多地址可以使用,但是别的子网就不不能用了.

因此我们希望从主机号中借用一些位作为网络号,这样就可以划分更多的子网,提高地址利用率.这种方法称为子网划分(Subnetting).

我们使用子网掩码来表示子网划分的情况.子网掩码也是一个32位的二进制数,与IPV4地址进行与运算,得到网络地址.

子网划分将原来的两级IP地址（网络号、主机号）转变为三级IP地址（网络号、子网号、主机号）。子网号是从原来的主机号部分借位而来的。

<div style="text-align: center;">
    <img src="../../../image/mac192.png" width="80%">
    <br>
    <caption>IP地址结构</caption>
</div>

子网掩码由一连串的1和一连串的0组成，其中1对应IP地址中的网络号和子网号，0对应主机号。

!!! example "子网划分示例"
    假设有一个B类网络 `145.13.0.0`，其默认子网掩码为 `255.255.0.0`。现在需要将其划分为多个子网，每个子网最多容纳约500台主机。

    1.  **确定主机位数**：
        为了容纳500台主机，我们需要确定主机号所需的位数 `n`。
        $$ 2^n - 2 \ge 500 $$
        计算可知，$2^9 - 2 = 510$，满足条件。因此，主机号需要9位。

    2.  **确定子网位数**：
        B类地址的主机号部分有16位。借走一部分给子网号后，还剩9位给主机号。
        因此，子网号的位数为：$16 - 9 = 7$ 位。

    3.  **计算子网掩码**：
        新的子网掩码在默认B类掩码的基础上，将原主机号部分的前7位置为1。

        -   默认B类掩码：`11111111.11111111.00000000.00000000`

        -   新的子网掩码：`11111111.11111111.11111110.00000000`

        -   转换为十进制：`255.255.254.0`

    4.  **计算子网数量**：
        子网号有7位，因此可以划分出 $2^7 = 128$ 个子网。

    通过这种方式，原有的一个B类网络被成功地划分成了128个更小的子网，每个子网可以容纳510台主机，极大地提高了IP地址的利用率。

### 无分类编址CIDR(Classless Inter-Domain Routing)

随着互联网的发展，分类编址的局限性愈发明显，即使有子网划分，地址浪费和路由表庞大的问题依然存在。为此，IETF提出了**无分类域间路由（CIDR）**。

CIDR消除了传统的A、B、C类地址和子网划分的概念，将32位的IP地址划分为两部分：**网络前缀**和**主机号**.

$$ \text{IP地址} ::= \{<\text{网络前缀}>, <\text{主机号}>\} $$

CIDR采用**斜线记法**，在IP地址后面加上`/`和网络前缀的位数。例如，`128.14.32.8/20`表示该IP地址的前20位是网络前缀，后12位是主机号。

**CIDR地址块**：CIDR将网络前缀相同的连续IP地址组成一个“CIDR地址块”. 我们可以根据地址块的起始地址和网络前缀长度，计算出地址块的范围：

- **地址块中的地址数**：$2^{32 - \text{网络前缀长度}}$
- **最小地址**：网络前缀部分不变，主机号部分全为0。
- **最大地址**：网络前缀部分不变，主机号部分全为1。

!!! example "CIDR地址块计算"
    对于地址块 `128.14.32.0/20`：

    - **地址数**：$2^{32-20} = 2^{12} = 4096$ 个地址。
    - **子网掩码**：前20位为1，后12位为0，即 `255.255.240.0`。
    - **最小地址**：`128.14.32.0`
    - **最大地址**：`128.14.47.255`

    因此，该地址块的范围是 `128.14.32.0` 到 `128.14.47.255`。

无分类编址相比于之前,最大的进步就是更加灵活了,不需要固定8,16或者24位作为网络号,可以根据实际需求划分任意长度的网络前缀.形成自定义大小的子网.

### 路由聚合（构成超网）

CIDR的一个核心优势是**路由聚合**，它允许将多个连续的CIDR地址块合并成一个更大的地址块，从而在路由表中用一个条目来表示多个网络。这个过程也称为**构成超网（Supernetting）**。

例如，一个ISP拥有`206.0.68.0/22`到`206.0.71.0/22`这4个地址块。它可以向外界宣告它拥有一个更大的地址块`206.0.68.0/20`，这样外部路由器只需要一条路由记录就能找到这个ISP下的所有主机。

路由聚合极大地减少了路由表的规模，减轻了路由器的负担，提高了互联网的整体性能。

<div style="text-align: center;">
    <img src="../../../image/mac197.png" width="80%">
    <br>
    <caption>路由聚合示例</caption>
</div>

要找到聚合后的共同前缀，只需对所有地址进行“按位与”运算。

### 最长前缀匹配

由于路由聚合的存在，路由表中可能会出现多个匹配目的IP地址的条目。例如，一个路由器中可能有：

- `206.0.68.0/20` -> 路由器R1
- `206.0.70.0/22` -> 路由器R2

当一个目的地址为`206.0.70.130`的数据包到达时，两个条目都能匹配。此时，路由器会采用**最长前缀匹配**原则，选择网络前缀最长的那个条目进行转发。在这个例子中，`/22`比`/20`更长，因此数据包会被转发给路由器R2。


---

## IPv4地址与MAC地址

数据链路层将IP数据报封装为帧进行传输,而帧的发送和接收是通过MAC地址来实现的.因此,在同一局域网内,需要将IP地址转换为对应的MAC地址.

在帧的传输过程中,源IP地址和目的IP地址保持不变,但源MAC地址和目的MAC地址会根据每一跳的链路进行更新.每个路由器在转发数据包时,会将目的MAC地址设置为下一跳路由器的MAC地址.

然而,在同一局域网内,主机需要知道目的IP地址对应的MAC地址,以便正确发送帧.为此,引入了地址解析协议(ARP).

### 地址解析协议 (ARP)

地址解析协议（ARP, Address Resolution Protocol）的作用是在局域网中，根据一个已知的IP地址，找出其对应的MAC地址。

每台主机或路由器都有一个**ARP缓存表（ARP Cache）**，用于存储本局域网内各主机和路由器的IP地址与MAC地址的对应关系。

**工作流程如下：**

1.  **检查ARP缓存**：
    当主机A想给本局域网内的主机B发送IP数据报时，它会首先在自己的ARP缓存表中查找是否有主机B的IP地址对应的条目。

    -   **如果找到**：就直接从缓存中读取主机B的MAC地址，并用该MAC地址作为目的地址来封装数据帧，然后发送。

    -   **如果未找到**：则进入下一步。

2.  **发送ARP请求**：
    主机A会在本局域网内以**广播**的形式发送一个**ARP请求分组**。该请求分组的主要内容是：“我的IP地址是`IP_A`，我的MAC地址是`MAC_A`。我想知道IP地址为`IP_B`的主机的MAC地址是什么？”

3.  **目标主机响应**：
    局域网内的所有主机都会收到这个广播的ARP请求。

    -   其他主机发现请求的IP地址不是自己，就会忽略该请求。当然,也可以在这时将A的IP和MAC地址存入自己的ARP缓存表中,以备后用.

    -   主机B发现请求的IP地址与自己的IP地址相匹配，它就会向主机A发送一个**ARP响应分组**。这个响应是**单播**的，直接发送给主机A。响应分组的内容是：“我的IP地址是`IP_B`，我的MAC地址是`MAC_B`。”

4.  **更新缓存并发送数据**：

    主机A收到主机B的ARP响应后，就知道了主机B的MAC地址。它会将这个IP到MAC的映射关系存入自己的ARP缓存表中（通常会设置一个生存时间，如20分钟），然后用这个MAC地址来封装数据帧并发送给主机B。

### IP数据报的发送和转发

如果一个主机A向另一个主机B发送数据报,首先需要判断主机B是否在同一局域网内.

- 查看子网掩码,将主机A的IP地址和主机B的IP地址分别与子网掩码进行与运算,如果结果相同,则说明两台主机在同一局域网内.

如果不在同一局域网内,主机A需要将数据报发送给默认网关(路由器).此时,主机A需要知道默认网关的MAC地址,通过ARP协议获取.

默认网关在收到数据报后,首先检查收到的IP报是否正确,然后根据路由表选择下一跳路由器,将数据报封装在新的帧中发送出去.在这个过程中,路由器会更新帧的源MAC地址和目的MAC地址,但IP报的源IP地址和目的IP地址保持不变.


###  IPv4数据报的首部格式

<div style="text-align: center;">
    <img src="../../../image/mac198.png" width="80%">
    <br>
    <caption>IPv4数据报首部格式</caption>
</div>

- 固定部分(20字节):

    - 版本(Version): 4位,表示IP协议的版本号,IPv4为4.

    - 首部长度(IHL): 4位,表示IP数据报首部的长度,单位为32位(4字节).比如,如果首部长度为5,则表示首部长度为20字节(仅包含固定部分).

    - 服务类型(Type of Service): 8位,用于指示数据报的优先级和服务质量要求.

    - 总长度(Total Length): 16位,表示整个IP数据报的长度,单位为字节.

    - 标识(Identification): 16位,用于唯一标识一个IP数据报,在分片时使用.

    - 标志(Flags): 3位,用于控制和标识分片.

    - 片偏移(Fragment Offset): 13位,表示分片在原始数据报中的位置.
    - 生存时间(Time to Live, TTL): 8位,用于防止数据报在网络中无限循环.
    - 协议(Protocol): 8位,表示上层协议类型,如TCP为6,UDP为17.
    - 首部校验和(Header Checksum): 16位,用于检测IP数据报首部在传输过程中是否出错.
    - 源IP地址(Source IP Address): 32位,表示发送方的IP地址.
    - 目的IP地址(Destination IP Address): 32位,表示接收方的IP地址.

- 可选部分(0-40字节): 可选字段,用于扩展IP数据报的功能,如安全选项、时间戳等.

- 填充部分: 用0填充首部,使其长度为32位(四字节)的整数倍.

!!! definition "IPV4的分片"
    我们知道,帧的数据载荷长度是有限制的,不同类型的链路有不同的最大传输单元(MTU,Maximum Transmission Unit).当IP数据报的长度超过链路的MTU时,就需要进行分片(Fragmentation).这就用到了IP数据报首部中的标识、标志和片偏移字段.

    - 标识:属于同一个IPv4数据报的各分片数据报应该具有相同的标识。

    - 标志:三位的作用分别是
        - 第1位: 保留位,必须为0.

        - 第2位: 不分片位(DF, Don't Fragment),如果设置为1,表示该数据报不能被分片.

        - 第3位: 更多分片位(MF, More Fragments),如果设置为1,表示后面还有分片;如果为0,表示这是最后一个分片.

    - 片偏移:表示该分片在原始数据报中的位置,单位为8字节(64位).例如,如果一个分片的片偏移为100,则表示该分片在原始数据报中的位置是第800字节(100*8).

    <div style="text-align: center;">
        <img src="../../../image/mac199.png" width="80%">
        <br>
        <caption>IPV4分片示例</caption>
    </div>


!!! definition "首部校验和"
    发送端端计算方法为:

    1. 将首部看作一系列16位的字(Word),如果首部长度不是16位的整数倍,则在末尾补0.

    2. 将原来的校验和字段设为0.

    3. 将所有16位字相加,如果在加法过程中产生了最高位（第 16 位）的进位（Carry）,则将该进位加到结果的最低位（第 1 位）上.

    4. 对结果取反,得到校验和.

    而接受方在接收到数据报后,也会按照相同的方法计算校验和,如果结果全为1,则表示数据报首部没有错误;否则,表示数据报首部在传输过程中发生了错误,需要丢弃该数据报.

    原理是$A + \bar{A} = -1$.

### 静态路由
> 静态路由是手动添加的路由条目,通常用于小型网络或特定的路由需求.管理员需要手动配置每个路由器的路由表,指定目的地址、子网掩码、下一跳地址和出接口等信息.

默认路由是一种特殊的静态路由,用于处理那些目的地址不在路由表中的数据报.默认路由通常指向一个网关(路由器),当路由器无法在路由表中找到匹配的条目时,就会将数据报发送到默认路由指定的网关.

为了在最长前缀匹配规则下,最后使用默认路由,默认路由的网络前缀长度为0,表示匹配所有目的地址,也即`0.0.0.0/0`

特定主机路由是另一种静态路由,用于指定某个特定主机的路由路径.这种路由条目的网络前缀长度为32,表示只匹配该主机的IP地址.


## RIP协议

路由信息协议(Routing Information Protocol,RIP)是一种基于距离矢量算法的动态路由协议.

该协议要求每一个路由器维护一个路由表,记录到达各个目的网络的距离(跳数)和下一跳路由器地址.路由器通过定期和相邻路由器交换路由信息来更新路由表.

路由器到直连网络的距离为1,到其他网络的距离为经过的路由器数量.超过15跳的网络被认为是不可达的.